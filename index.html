<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>哼唱识别</title>
<link rel="stylesheet" type="text/css" href="css/style.css">
</head>
<body class="keBody">
<div class="kePublic">
<canvas id='canvas' width="1000" height="600"></canvas>
<br>
<a href="javascript:rec.start()" id="rec-node">录制</a>
<span id="max-posi"></span>
<br>
<script>
window.AudioContext = window.AudioContext || window.webkitAudioContext || window.mozAudioContext;

var rec={
    "recMode":false,
    "last" : null,
    "noteList" : null,
    "noteLen"  : 0,
    "noteMinLen" : 2,
    "addNote"  : function(){
        if(this.last[0])
            this.noteList.push([this.last[0],this.noteLen]);
    },
    "pushNote" : function(tone,vol) {
        if(!this.recMode)
            return;
        if(this.last!=null){
            if(vol > (this.last[1]/2)){
                try {
                    if(this.last[0] && this.last[0][2]==tone[2]){
                        ++this.noteLen;
                    }else{
                        this.addNote();
                        this.noteLen=0;
                        this.last = [tone,vol];
                    }
                }catch (e) {
                    console.log(e);
                }
                
            }
        }else {
            this.last = [tone,vol];
        }
    },
    "start" : function(){
        if(this.recMode){
            this.recMode=false;
            this.addNote();
            console.log(this.noteList);
            document.getElementById("rec-node").innerText="录制";
        }else{
            this.recMode=true;
            this.noteList = [];
            document.getElementById("rec-node").innerText="停止";
        }
    }
};

var toneTable={
    "C4"        :null,
    "toneBuffer":new Array(600),
    "log2"      :Math.log(2),
    "toneMap"   :["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],
    "init" : function (c) {
        this.C4=c || 48;
        this.buildBuffer();
    },
    "getToneId" : function(v){
        return (Math.log(v/this.C4)/this.log2)*12+48;
    },
    "getNameById" : function(id){
        if(id<0)
            return null;
        var level = Math.floor(id/12);
        var tid   = id%12;
        return [this.toneMap[tid],level,id];
    },
    "getToneName" : function(v){
        return this.getNameById(Math.round(this.getToneId(v)));
    },
    "buildBuffer" : function(){
        for (var i=0;i<600;i++) {
            this.toneBuffer[i]=this.getToneName(i);
        }
    }
};
toneTable.init(72.5);//校准C4的音高

function lagInt4(x0,x1,x2,x3,y0,y1,y2,y3,x) {
    var res=(((x-x1)*(x-x2)*(x-x3))/((x0-x1)*(x0-x2)*(x0-x3)))*y0;
    res   +=(((x-x0)*(x-x2)*(x-x3))/((x1-x0)*(x1-x2)*(x1-x3)))*y1;
    res   +=(((x-x0)*(x-x1)*(x-x3))/((x2-x0)*(x2-x1)*(x2-x3)))*y2;
    res   +=(((x-x0)*(x-x1)*(x-x2))/((x3-x0)*(x3-x1)*(x3-x2)))*y3;
    return res;
}
window.onload = function() {
    navigator.mozGetUserMedia({
        audio: true
    },
    function(stream) {
        
        var audioContext = new AudioContext();
        inputPoint = audioContext.createGain();
        var realAudioInput = audioContext.createMediaStreamSource(stream);
        realAudioInput.connect(inputPoint);
        analyserNode = audioContext.createAnalyser();
        analyserNode.fftSize = 2048;
        analyserNode.smoothingTimeConstant = 0.1;
        inputPoint.connect( analyserNode );
        
        var frequencyData = new Uint8Array(analyserNode.frequencyBinCount);

        // we're ready to receive some data!
        var canvas = document.getElementById('canvas'),
        cwidth = canvas.width,
        cheight = canvas.height - 2,
        meterWidth = 1,
        //width of the meters in the spectrum
        gap = 2,
        //gap between meters
        capHeight = 2,
        capStyle = '#fff',
        meterNum = 1000,
        //count of the meters
        capYPositionArray = []; ////store the vertical position of hte caps for the preivous frame
        var ctx = canvas.getContext('2d'),
        gradient = ctx.createLinearGradient(0, 0, 0, 600);
        gradient.addColorStop(1, '#0f0');
        gradient.addColorStop(0.5, '#ff0');
        gradient.addColorStop(0, '#f00');
        // loop
        var j=0;
        var maxEle=document.getElementById("max-posi");
        function renderFrame() {
            var oarray = new Uint8Array(analyserNode.frequencyBinCount);
            analyserNode.getByteFrequencyData(oarray);
            var array = new Uint8Array(600);
            
            for(var i=0;i<600;i++){
                var ox  = i/6.0;
                var ox1 = Math.floor(ox);
                var ox0 = ox1-1;
                var ox2 = ox1+1;
                var ox3 = ox1+2;
                var y3 = oarray[ox3];
                var y2 = oarray[ox2];
                var y1 = oarray[ox1];
                var y0 = 0;
                if(ox0>= 0)
                    y0 = oarray[ox0];
                array[i] = lagInt4(ox0,ox1,ox2,ox3,y0,y1,y2,y3,ox);
            }
            for(var i=1;i<600;i++){//滤掉突变
                if((array[i]-array[i-1])>32)
                   array[i]=array[i-1];
            }
            
            //ctx.clearRect(0, 0, cwidth, cheight);
            var maxValue=0;
            var maxPosi=0;
            for (var i = 16; i < 600; i++) {
                var value = array[i];
                var fstatus = new Uint8Array(600);
                
                ctx.fillStyle = "rgba(0,0,"+value+")";
                
                if(i>0 && i<600 && value>32
                   && value>array[i-1] && value>=array[i+1] 
                   && value>array[i-2] && value>=array[i+2]
                   && value>array[i-3] && value>=array[i+3]
                   && array[i-2]>array[i-3]
                   && array[i+2]>array[i+3]
                ){
                    if(value>maxValue){
                        maxValue = value;
                        maxPosi  = i;
                    }
                    fstatus[i]    = value;
                    var low = i>>1;
                    if(fstatus[low+1]!=0 || fstatus[low]!=0 || fstatus[low-1]!=0){
                    
                    }else
                        ctx.fillStyle = "rgba(0,"+value+",0)";
                }
                
                ctx.fillRect(j
                /*meterWidth+gap*/
                , 600-i, 1, 1); //the meter
            }
            ++j;
            if(j>=1000)
                j=0;
            try{
                var t = toneTable.toneBuffer[maxPosi];
                if(!t)
                    maxEle.innerText=maxPosi;
                else
                    maxEle.innerText=maxPosi + " " + "音符："+t[0]+" "+t[1] + " " + maxValue;
                    //maxEle.innerText=maxPosi;
                    rec.pushNote(t,maxValue);
            }catch (e) {
                
            }
            setTimeout(renderFrame,20);
        }
        renderFrame();
    },
    function(error) {
        console.log("错误：", error);
    });

};
</script>
<div class="clear"></div>
</div>


</body>
</html>
