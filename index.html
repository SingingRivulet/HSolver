<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>频谱</title>
<link rel="stylesheet" type="text/css" href="css/style.css">
</head>
<body class="keBody">
<div class="kePublic">
<canvas id='canvas' width="800" height="300"></canvas>
<br>
<div id="max-posi"></div>
<br>
<script>
window.AudioContext = window.AudioContext || window.webkitAudioContext || window.mozAudioContext;

var toneMap=new Array(24);
toneMap[12]="C"
toneMap[13]="D"
toneMap[14]="D"
toneMap[15]="E"
toneMap[16]="F"
toneMap[17]="G"
toneMap[18]="G"
toneMap[19]="G"
toneMap[20]="A"
toneMap[21]="A"
toneMap[22]="A"
toneMap[23]="B"
function getTone(v) {
    var l = Math.floor(Math.log(v/12)/Math.log(2));
    var t=0;
    if(l>0){
        t=Math.floor(v/(1<<l));
    }else
    if(l==0)
        t=v;
    else {
        return 0;
    }
    return {"level":l+4,"tone":t,"name":toneMap[t]};
}
window.onload = function() {
    navigator.mozGetUserMedia({
        audio: true
    },
    function(stream) {
        console.log(stream);
        
        var audioContext = new AudioContext();
        inputPoint = audioContext.createGain();
        var realAudioInput = audioContext.createMediaStreamSource(stream);
        realAudioInput.connect(inputPoint);
        analyserNode = audioContext.createAnalyser();
        analyserNode.fftSize = 2048;
        analyserNode.smoothingTimeConstant = 0.1;
        inputPoint.connect( analyserNode );
        
        var frequencyData = new Uint8Array(analyserNode.frequencyBinCount);

        // we're ready to receive some data!
        var canvas = document.getElementById('canvas'),
        cwidth = canvas.width,
        cheight = canvas.height - 2,
        meterWidth = 1,
        //width of the meters in the spectrum
        gap = 2,
        //gap between meters
        capHeight = 2,
        capStyle = '#fff',
        meterNum = 800,
        //count of the meters
        capYPositionArray = []; ////store the vertical position of hte caps for the preivous frame
        var ctx = canvas.getContext('2d'),
        gradient = ctx.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(1, '#0f0');
        gradient.addColorStop(0.5, '#ff0');
        gradient.addColorStop(0, '#f00');
        // loop
        var j=0;
        var maxEle=document.getElementById("max-posi");
        function renderFrame() {
            var array = new Uint8Array(analyserNode.frequencyBinCount);
            analyserNode.getByteFrequencyData(array);
            //ctx.clearRect(0, 0, cwidth, cheight);
            var maxValue=0;
            var maxPosi=0;
            for (var i = 4; i < 300; i++) {
                var value = array[i];
                var fstatus = new Uint8Array(300);
                if(value>maxValue){
                    maxValue = value;
                    maxPosi  = i;
                }
                ctx.fillStyle = "rgba(0,0,"+value+")";
                
                if(i>0 && i<300 && value>array[i-1] && value>=array[i+1]){
                    fstatus[i]    = value;
                    var low = i>>1;
                    if(fstatus[low+1]!=0 || fstatus[low]!=0 || fstatus[low-1]!=0){
                    
                    }else
                        ctx.fillStyle = "rgba("+value+","+value+",0)";
                }
                
                ctx.fillRect(j
                /*meterWidth+gap*/
                , 300-i, 1, 1); //the meter
            }
            ++j;
            if(j>=800)
                j=0;
            try{
                var t = getTone(maxPosi);
                if(t==0)
                    maxEle.innerText="";
                else
                    maxEle.innerText="音符："+t.name+" "+t.level;
            }catch (e) {
                
            }
            setTimeout(renderFrame,20);
        }
        renderFrame();
    },
    function(error) {
        console.log("错误：", error);
    });

};
</script>
<div class="clear"></div>
</div>


</body>
</html>
